# ============================================================================
# GapSense CI/CD Pipeline
#
# Runs the same checks as git hooks to catch anyone who skipped hooks
# ============================================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.12"  # CI uses 3.12 (adjust if needed)

jobs:
  # ==========================================================================
  # Quality Checks (Linting, Formatting, Type Checking)
  # ==========================================================================
  quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Run Ruff Linter
        run: poetry run ruff check src/ scripts/ alembic/

      - name: Run Ruff Formatter Check
        run: poetry run ruff format --check src/ scripts/ alembic/

      - name: Run MyPy Type Checker
        run: poetry run mypy src/

  # ==========================================================================
  # Tests (Unit + Integration)
  # ==========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      # PostgreSQL for integration tests
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: gapsense
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: gapsense_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Run Tests with Coverage (≥80%)
        run: poetry run pytest tests/ --cov=src/gapsense --cov-report=xml --cov-report=term-missing --cov-fail-under=80 -v --tb=short
        env:
          DATABASE_URL: postgresql+asyncpg://gapsense:testpass@localhost:5432/gapsense_test

      - name: Upload Coverage Reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true

  # ==========================================================================
  # Database Migrations Check
  # ==========================================================================
  migrations:
    name: Check Database Migrations
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: gapsense
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: gapsense_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Check Alembic Migrations
        run: poetry run alembic check || echo "No migrations to check"
        env:
          DATABASE_URL: postgresql+asyncpg://gapsense:testpass@localhost:5432/gapsense_test

  # ==========================================================================
  # Security Checks (CRITICAL for Ghana Data Protection Act compliance)
  # ==========================================================================
  security:
    name: Security & Code Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.8.2
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Detect Secrets
        run: poetry run detect-secrets scan --baseline .secrets.baseline

      - name: Bandit Security Scan
        run: poetry run bandit -c pyproject.toml -r src/

      - name: Safety Dependency Vulnerability Check
        run: poetry run safety check --json || echo "⚠️  Safety check failed or skipped"
        continue-on-error: true  # Don't fail build on Safety API issues

      - name: Vulture Dead Code Detection
        run: poetry run vulture src/ --min-confidence 80

      - name: Deptry Dependency Analysis
        run: poetry run deptry src/

  # ==========================================================================
  # Summary
  # ==========================================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality, test, migrations, security]
    if: always()

    steps:
      - name: Check Results
        run: |
          echo "Quality Checks: ${{ needs.quality.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Migrations: ${{ needs.migrations.result }}"
          echo "Security: ${{ needs.security.result }}"

          if [[ "${{ needs.quality.result }}" == "failure" || "${{ needs.test.result }}" == "failure" || "${{ needs.migrations.result }}" == "failure" || "${{ needs.security.result }}" == "failure" ]]; then
            echo "❌ CI Failed - Fix issues before merging"
            exit 1
          else
            echo "✅ All CI checks passed"
          fi
