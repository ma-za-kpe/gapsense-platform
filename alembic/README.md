# Alembic Database Migrations

This directory contains all database migration scripts for GapSense.

## Quick Start

### Create a New Migration

After modifying SQLAlchemy models in `src/gapsense/core/models/`, generate a migration:

```bash
alembic revision --autogenerate -m "Add user preferences table"
```

This creates a new migration file in `alembic/versions/`.

### Apply Migrations

```bash
# Apply all pending migrations
alembic upgrade head

# Apply specific migration
alembic upgrade <revision_id>

# Rollback one migration
alembic downgrade -1

# Rollback to specific migration
alembic downgrade <revision_id>

# Rollback all migrations
alembic downgrade base
```

### Check Migration Status

```bash
# Show current revision
alembic current

# Show migration history
alembic history

# Show pending migrations
alembic heads
```

## Migration Workflow

1. **Modify models** in `src/gapsense/core/models/`
2. **Generate migration**: `alembic revision --autogenerate -m "description"`
3. **Review migration file** in `alembic/versions/` (ALWAYS review!)
4. **Test migration**: Apply in dev environment
5. **Commit migration** to git
6. **Apply in production**: Run `alembic upgrade head`

## Important Notes

### Always Review Autogenerated Migrations

Alembic's autogenerate is smart but not perfect. ALWAYS review the generated migration file before applying:

- Check for unintended table/column drops
- Verify index and constraint changes
- Add data migrations if needed (e.g., populating new columns)
- Check for proper handling of nullable → non-nullable transitions

### Data Migrations

For migrations that involve data transformations, add custom Python code:

```python
def upgrade() -> None:
    # Schema change
    op.add_column('students', sa.Column('new_field', sa.String(100)))

    # Data migration
    conn = op.get_bind()
    conn.execute(
        sa.text("UPDATE students SET new_field = 'default' WHERE new_field IS NULL")
    )

    # Make non-nullable
    op.alter_column('students', 'new_field', nullable=False)
```

### Testing Migrations

```bash
# Apply migration
alembic upgrade head

# Rollback
alembic downgrade -1

# Re-apply to test both directions
alembic upgrade head
```

### Production Deployment

1. **Backup database** before migration
2. **Run in maintenance window** for large tables
3. **Test on staging first**
4. **Have rollback plan ready**

```bash
# Production migration command
alembic upgrade head
```

### Async Support

GapSense uses async SQLAlchemy. The `env.py` file is configured for async operations.

Migration functions (`upgrade()`, `downgrade()`) are synchronous, but Alembic handles the async engine internally.

## Seed Data

Initial seed data (curriculum strands, system config) should be:

1. Added to migration files (for schema-critical data)
2. OR loaded via `scripts/load_curriculum.py` (for proprietary IP)

**DO NOT** commit proprietary data (prerequisite graph, prompts) to migrations.

## Troubleshooting

### "Target database is not up to date"

```bash
alembic stamp head
```

### "Can't locate revision"

Delete `alembic/versions/__pycache__` and retry.

### "Multiple heads" (branched migration history)

```bash
alembic merge <rev1> <rev2> -m "merge branches"
```

### "No module named gapsense"

Ensure you're running from project root with virtual environment activated.

## File Structure

```
alembic/
├── README.md              # This file
├── env.py                 # Alembic environment (async config)
├── script.py.mako         # Migration template
└── versions/              # Migration files (auto-generated)
    └── YYYYMMDD_HHMM_<revision>_<message>.py
```
